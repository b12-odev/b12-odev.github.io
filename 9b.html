<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>9B Ödev Listesi</title>
<link rel="manifest" href="manifest.json">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

body {font-family:"Poppins", sans-serif; background: linear-gradient(180deg,#e9f5ff,#fff); margin:0; padding:0; display:flex; flex-direction:column; min-height:100vh;}
h1 {text-align:center; color:#1d3557; margin-top:25px; font-size:1.8em; display:flex; align-items:center; justify-content:center;}
h1 img {height:40px; margin-right:10px;}

.container {flex:1; max-width:520px; margin:20px auto; background:#fff; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:25px 20px 40px 20px; transition:0.3s ease;}
button {background:#457b9d; color:white; border:none; padding:12px; width:100%; border-radius:8px; cursor:pointer; font-weight:600; font-size:1em; transition:background 0.2s;}
button:hover {background:#356e8c;}
#toplamBtn {background:#1d3557; margin-top:15px;}
.form {display:none; margin-top:15px; animation:fadeIn 0.3s;}
@keyframes fadeIn {from{opacity:0; transform:translateY(-10px);}to{opacity:1; transform:translateY(0);}}
.form input, .form textarea {width:100%; margin-bottom:12px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:0.95em;}
.form label {font-size:0.9em; color:#555; display:block; margin-bottom:5px;}
.odev {position:relative; background:#f8f9fa; border-radius:10px; padding:12px 15px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); transition:0.2s; display:flex; justify-content:space-between; align-items:center;}
.odev:hover {transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.1);}
.odev b {font-size:1.1em; color:#1d3557;}
.odev small {color:#666;}
.etiket {font-weight:bold; padding:2px 10px; border-radius:20px; font-size:0.85em; white-space:nowrap; position:absolute; top:10px; right:10px; opacity:0; animation:bubble 0.3s forwards;}
.bugun {background:#2a9d8f; color:white;}
.yarina {background:#e9c46a; color:#333;}
.gecmis {background:#e63946; color:white;}
@keyframes bubble {0%{transform:scale(0.5); opacity:0;}100%{transform:scale(1); opacity:1;}}
.bos {text-align:center; color:#777; font-size:1.1em; margin-top:20px;}
footer {text-align:center; font-size:0.9em; color:#444; margin-top:auto; padding:20px;}
#gizli {opacity:0; text-align:center; font-size:1.1em; color:#1d3557; transition:opacity 0.5s; font-weight:bold; padding-bottom:40px;}
#toplamTablo {width:100%; border-collapse:collapse; margin-top:10px;}
#toplamTablo th, #toplamTablo td {border:1px solid #ccc; padding:6px; text-align:center;}
#toplamTablo tbody {display:none;}
</style>
</head>
<body>

<h1><img src="logo.png" alt="Okul Logo">9B Ödev Listesi</h1>
<div class="container">

<button id="ekleBtn">+ Ödev Ekle</button>
<div class="form" id="odevForm">
  <input list="dersList" type="text" id="ders" placeholder="Ders adı" required>
  <datalist id="dersList"></datalist>
  <textarea id="aciklama" placeholder="Ödev açıklaması" rows="2" required></textarea>
  <label for="tarih">Ödev ne zamana:</label>
  <input type="date" id="tarih" required>
  <input list="ekleyenList" type="text" id="ekleyen" placeholder="Ekleyen (isteğe bağlı)">
  <datalist id="ekleyenList"></datalist>
  <button id="kaydetBtn">Kaydet</button>
</div>

<h2>Güncel Ödevler</h2>
<div id="liste"></div>

<button id="toplamBtn">En Çok Ödev Yükleyenler ▼</button>
<table id="toplamTablo">
  <thead><tr><th>#</th><th>Öğrenci</th><th>Ödev Sayısı</th></tr></thead>
  <tbody></tbody>
</table>

</div>

<footer>
<p>Erdem Ata tarafından yapıldı</p>
</footer>
<p id="gizli">Sınıfı için yaptı 😏</p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, query, orderBy, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyADRrn05EmhYR4eZoA9JegJ0ESpw2fPI4g",
  authDomain: "dokuzbode.firebaseapp.com",
  projectId: "dokuzbode",
  storageBucket: "dokuzbode.firebasestorage.app",
  messagingSenderId: "43132793959",
  appId: "1:43132793959:web:f4905f1a6503983d0a10c2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ekleBtn = document.getElementById("ekleBtn");
const odevForm = document.getElementById("odevForm");
const kaydetBtn = document.getElementById("kaydetBtn");
const liste = document.getElementById("liste");
const toplamBtn = document.getElementById("toplamBtn");
const toplamTabloBody = document.querySelector("#toplamTablo tbody");
const dersList = document.getElementById("dersList");
const ekleyenList = document.getElementById("ekleyenList");

ekleBtn.addEventListener("click", ()=>{
  odevForm.style.display="block";
  ekleBtn.style.display="none";
});

kaydetBtn.addEventListener("click", async ()=>{
  const ders = document.getElementById("ders").value.trim();
  const aciklama = document.getElementById("aciklama").value.trim();
  const tarih = document.getElementById("tarih").value;
  const ekleyen = document.getElementById("ekleyen").value.trim() || "Anonim";

  if(!ders || !aciklama || !tarih){alert("Lütfen tüm alanları doldur!"); return;}

  await addDoc(collection(db,"odevler"),{
    ders, aciklama, tarih, ekleyen, yuklenmeZamani: new Date().toISOString()
  });

  document.getElementById("ders").value="";
  document.getElementById("aciklama").value="";
  document.getElementById("tarih").value="";
  document.getElementById("ekleyen").value="";
  odevForm.style.display="none";
  ekleBtn.style.display="block";

  await eskiOdevleriSil();
  await listeyiGoster();
  await tabloGuncelle();
});

async function listeyiGoster(){
  liste.innerHTML="";
  const q = query(collection(db,"odevler"), orderBy("yuklenmeZamani","asc"));
  const snapshot = await getDocs(q);
  const odevler=[];
  snapshot.forEach(doc => odevler.push({...doc.data(),id:doc.id}));

  if(odevler.length===0){
    const mesajlar=["Bugünlük ödev yok 😎","Rahatla, ödev yok 🧘","Günün keyfini çıkar 🎮"];
    liste.innerHTML=`<div class='bos'>${mesajlar[Math.floor(Math.random()*mesajlar.length)]}</div>`;
    return;
  }

  const bugunTarih = new Date(); bugunTarih.setHours(0,0,0,0);
  odevler.forEach(o=>{
    const teslim = new Date(o.tarih);
    const farkGun = (teslim - bugunTarih)/(1000*60*60*24);
    if(farkGun<0) o.etiket="gecmis";
    else if(farkGun===0) o.etiket="bugun";
    else if(farkGun===1) o.etiket="yarina";
    else o.etiket="";
  });

  odevler.sort((a,b)=>{
    const order={"yarina":1,"bugun":2,"":3,"gecmis":4};
    if(order[a.etiket]!==order[b.etiket]) return order[a.etiket]-order[b.etiket];
    return new Date(a.tarih)-new Date(b.tarih);
  });

  odevler.forEach(o=>{
    let etiketHTML="";
    if(o.etiket==="bugun") etiketHTML=`<span class="etiket bugun">Bugün!</span>`;
    else if(o.etiket==="yarina") etiketHTML=`<span class="etiket yarina">Yarına!</span>`;
    else if(o.etiket==="gecmis") etiketHTML=`<span class="etiket gecmis">Teslim süresi doldu</span>`;

    liste.innerHTML+=`
    <div class="odev">
      <div>
        <b>${o.ders}</b><br>
        <span>${o.aciklama}</span><br>
        <small>Son tarih: ${o.tarih} <br> Ödevi ekleyen: ${o.ekleyen}</small>
      </div>
      ${etiketHTML}
    </div>`;
  });

  // autocomplete güncelle
  const dersSet = new Set();
  const ekleyenSet = new Set();
  odevler.forEach(o=>{
    dersSet.add(o.ders);
    ekleyenSet.add(o.ekleyen);
  });
  dersList.innerHTML=""; ekleyenList.innerHTML="";
  dersSet.forEach(d=> dersList.innerHTML += `<option value="${d}">`);
  ekleyenSet.forEach(e=> ekleyenList.innerHTML += `<option value="${e}">`);
}

async function tabloGuncelle(){
  toplamTabloBody.innerHTML="";
  const snapshot = await getDocs(collection(db,"odevler"));
  const sayac = {};
  snapshot.forEach(doc => {
    const ek = doc.data().ekleyen || "Anonim";
    sayac[ek] = (sayac[ek]||0)+1;
  });
  const entries = Object.entries(sayac).sort((a,b)=>b[1]-a[1]);
  entries.forEach((e,i)=>{
    toplamTabloBody.innerHTML+=`<tr><td>${i+1}</td><td>${e[0]}</td><td>${e[1]}</td></tr>`;
  });
}

toplamBtn.addEventListener("click", ()=>{
  if(toplamTabloBody.style.display==="table-row-group"){
    toplamTabloBody.style.display="none";
    toplamBtn.textContent="En Çok Ödev Yükleyenler ▼";
  } else {
    toplamTabloBody.style.display="table-row-group";
    toplamBtn.textContent="En Çok Ödev Yükleyenler ▲";
  }
});

async function eskiOdevleriSil(){
  const snapshot = await getDocs(collection(db,"odevler"));
  const bugun = new Date(); bugun.setHours(0,0,0,0);
  snapshot.forEach(async docu=>{
    const o = docu.data();
    const teslim = new Date(o.tarih);
    const farkGun = (bugun - teslim)/(1000*60*60*24);
    if(farkGun >= 1){
      await deleteDoc(doc(db,"odevler",docu.id));
    }
  });
}

window.addEventListener("scroll",()=>{
  const gizli=document.getElementById("gizli");
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-10) gizli.style.opacity="1";
  else gizli.style.opacity="0";
});

// Sayfa açılışında
listeyiGoster();
tabloGuncelle();
eskiOdevleriSil();
setInterval(async ()=>{
  await eskiOdevleriSil();
  await listeyiGoster();
  await tabloGuncelle();
},2*60*1000);
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(registration => {
          console.log('ServiceWorker kaydedildi: ', registration.scope);
        })
        .catch(error => {
          console.log('ServiceWorker kaydı başarısız: ', error);
        });
    });
  }
</script>

</body>
</html>
